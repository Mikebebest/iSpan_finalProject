<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unified Voice & Camera Control</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #photo { width: 50%; border: 1px solid #ccc; margin-top: 10px; display: none; }
    button { margin: 4px; padding: 8px 12px; }
    #alert { font-weight: bold; font-size: 24px; display: none; }
    #text { font-size: 20px; font-weight: bold; display: none; }
    #status { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h1>🎤 Voice & 📸 Camera Controller</h1>

  <!-- 語音監聽狀態 -->
  <h2>🎤 語音辨識狀態</h2>
  <p id="status">🟢 背景監聽中...</p>
  <p id="alert"></p>
  <p id="text"></p>

  <h2>🤖 Servo Control</h2>
  <button onclick="sendMove('up')">⬆️ Up</button>
  <button onclick="sendMove('down')">⬇️ Down</button>
  <button onclick="sendMove('left')">⬅️ Left</button>
  <button onclick="sendMove('right')">➡️ Right</button>

  <h2>📸 拍照設定</h2>
  Width: <input type="number" id="width" value="1280" style="width:80px;">
  Height: <input type="number" id="height" value="720" style="width:80px;">
  <br><br>
  <button onclick="capture()">📷 Capture</button>

  <h2>📸 最新照片</h2>
  <img id="photo" src="">

  <script>
    const host = location.hostname;
    const wsVoice = new WebSocket(`ws://${host}:8081`);
    const wsMove = new WebSocket(`ws://${host}:8082`);
  
    const alertElement = document.getElementById('alert');
    const textElement = document.getElementById('text');
  
    // 語音辨識 WebSocket 收到資料時處理
    wsVoice.onmessage = (event) => {
      const text = event.data.trim().toLowerCase();
      console.log("🎤 收到語音文字:", text);
  
      alertElement.style.display = 'none';
      textElement.style.display = '';
      textElement.textContent = `🎤 辨識到: ${text}`;
      textElement.style.color = "black";
  
      if (text.includes("help")) {
        showAlert("🚨 EMERGENCY! 緊急狀況 🚨", 'emergency');
        sendCommand("emergency");
      } else if (text.includes("hello")) {
        showAlert("💡 開燈指令已送出！", 'light-on');
        sendCommand("light on");
      } else if (text.includes("bye bye")) {
        showAlert("💤 關燈指令已送出！", 'light-off');
        sendCommand("light off");
      }
    };
  
    // 加入 wsMove 連線狀態 log
    wsMove.onopen = () => console.log("✅ wsMove connected");
    wsMove.onerror = err => console.error("❌ wsMove error", err);
    wsMove.onclose = () => console.warn("⚠️ wsMove closed");
  
    function showAlert(msg, type) {
      alertElement.textContent = msg;
      alertElement.style.display = 'block';
      alertElement.style.color = {
        'emergency': 'red',
        'light-on': 'green',
        'light-off': 'gray'
      }[type] || 'black';
    }
  
    function sendCommand(cmd) {
      fetch(`/send?cmd=${cmd}`).catch(err => {
        console.error("❌ Failed to send command:", err);
      });
    }
  
    function sendMove(dir) {
      console.log("➡️ 嘗試發送 move 指令:", dir);
      if (wsMove.readyState === WebSocket.OPEN) {
        wsMove.send(`move ${dir}`);
      } else {
        console.warn("⚠️ WebSocket 尚未連線或已關閉");
      }
    }
  
    function capture() {
      const width = document.getElementById('width').value;
      const height = document.getElementById('height').value;
      const photo = document.getElementById('photo');
      photo.style.display = 'none';
  
      fetch(`/capture?width=${width}&height=${height}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            photo.src = `/uploads/${data.filename}?t=${Date.now()}`;
            photo.onload = () => photo.style.display = 'block';
          }
        })
        .catch(() => {
          console.error("❌ 拍照失敗");
          photo.style.display = 'none';
        });
    }
  
    document.addEventListener('keydown', e => {
      switch (e.key) {
        case 'ArrowUp':    sendMove('up');    break;
        case 'ArrowDown':  sendMove('down');  break;
        case 'ArrowLeft':  sendMove('left');  break;
        case 'ArrowRight': sendMove('right'); break;
      }
    });
  </script>
  
</body>
</html>