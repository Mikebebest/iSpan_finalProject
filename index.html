<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unified Voice & Camera Control</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #photo { width: 50%; border: 1px solid #ccc; margin-top: 10px; display: none; }
    button { margin: 4px; padding: 8px 12px; }
    #alert { font-weight: bold; font-size: 24px; display: none; }
    #text { font-size: 20px; font-weight: bold; display: none; }
    #status { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ğŸ¤ Voice & ğŸ“¸ Camera Controller</h1>

  <!-- èªéŸ³ç›£è½ç‹€æ…‹ -->
  <h2>ğŸ¤ èªéŸ³è¾¨è­˜ç‹€æ…‹</h2>
  <p id="status">ğŸŸ¢ èƒŒæ™¯ç›£è½ä¸­...</p>
  <p id="alert"></p>
  <p id="text"></p>

  <h2>ğŸ¤– Servo Control</h2>
  <button onclick="sendMove('up')">â¬†ï¸ Up</button>
  <button onclick="sendMove('down')">â¬‡ï¸ Down</button>
  <button onclick="sendMove('left')">â¬…ï¸ Left</button>
  <button onclick="sendMove('right')">â¡ï¸ Right</button>

  <h2>ğŸ“¸ æ‹ç…§è¨­å®š</h2>
  Width: <input type="number" id="width" value="1280" style="width:80px;">
  Height: <input type="number" id="height" value="720" style="width:80px;">
  <br><br>
  <button onclick="capture()">ğŸ“· Capture</button>

  <h2>ğŸ“¸ æœ€æ–°ç…§ç‰‡</h2>
  <img id="photo" src="">

  <script>
    const host = location.hostname;
    const wsVoice = new WebSocket(`ws://${host}:8081`);
    const wsMove = new WebSocket(`ws://${host}:8082`);
  
    const alertElement = document.getElementById('alert');
    const textElement = document.getElementById('text');
  
    // èªéŸ³è¾¨è­˜ WebSocket æ”¶åˆ°è³‡æ–™æ™‚è™•ç†
    wsVoice.onmessage = (event) => {
      const text = event.data.trim().toLowerCase();
      console.log("ğŸ¤ æ”¶åˆ°èªéŸ³æ–‡å­—:", text);
  
      alertElement.style.display = 'none';
      textElement.style.display = '';
      textElement.textContent = `ğŸ¤ è¾¨è­˜åˆ°: ${text}`;
      textElement.style.color = "black";
  
      if (text.includes("help")) {
        showAlert("ğŸš¨ EMERGENCY! ç·Šæ€¥ç‹€æ³ ğŸš¨", 'emergency');
        sendCommand("emergency");
      } else if (text.includes("hello")) {
        showAlert("ğŸ’¡ é–‹ç‡ˆæŒ‡ä»¤å·²é€å‡ºï¼", 'light-on');
        sendCommand("light on");
      } else if (text.includes("bye bye")) {
        showAlert("ğŸ’¤ é—œç‡ˆæŒ‡ä»¤å·²é€å‡ºï¼", 'light-off');
        sendCommand("light off");
      }
    };
  
    // åŠ å…¥ wsMove é€£ç·šç‹€æ…‹ log
    wsMove.onopen = () => console.log("âœ… wsMove connected");
    wsMove.onerror = err => console.error("âŒ wsMove error", err);
    wsMove.onclose = () => console.warn("âš ï¸ wsMove closed");
  
    function showAlert(msg, type) {
      alertElement.textContent = msg;
      alertElement.style.display = 'block';
      alertElement.style.color = {
        'emergency': 'red',
        'light-on': 'green',
        'light-off': 'gray'
      }[type] || 'black';
    }
  
    function sendCommand(cmd) {
      fetch(`/send?cmd=${cmd}`).catch(err => {
        console.error("âŒ Failed to send command:", err);
      });
    }
  
    function sendMove(dir) {
      console.log("â¡ï¸ å˜—è©¦ç™¼é€ move æŒ‡ä»¤:", dir);
      if (wsMove.readyState === WebSocket.OPEN) {
        wsMove.send(`move ${dir}`);
      } else {
        console.warn("âš ï¸ WebSocket å°šæœªé€£ç·šæˆ–å·²é—œé–‰");
      }
    }
  
    function capture() {
      const width = document.getElementById('width').value;
      const height = document.getElementById('height').value;
      const photo = document.getElementById('photo');
      photo.style.display = 'none';
  
      fetch(`/capture?width=${width}&height=${height}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            photo.src = `/uploads/${data.filename}?t=${Date.now()}`;
            photo.onload = () => photo.style.display = 'block';
          }
        })
        .catch(() => {
          console.error("âŒ æ‹ç…§å¤±æ•—");
          photo.style.display = 'none';
        });
    }
  
    document.addEventListener('keydown', e => {
      switch (e.key) {
        case 'ArrowUp':    sendMove('up');    break;
        case 'ArrowDown':  sendMove('down');  break;
        case 'ArrowLeft':  sendMove('left');  break;
        case 'ArrowRight': sendMove('right'); break;
      }
    });
  </script>
  
</body>
</html>