<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice & Servo Control Monitor</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  button { margin: 4px; padding: 8px 12px; }
  #photo { width: 50%; border: 1px solid #ccc; margin-top: 10px; display: none; }
  #status { color: green; font-weight: bold; margin-top: 20px; }
  #text { font-size: 24px; font-weight: bold; margin-top: 20px; display: none; color: black; }
  #alert { font-size: 32px; font-weight: bold; margin-top: 20px; display: none; }
  .emergency { color: red; }
  .light-on { color: dodgerblue; }
  .light-off { color: orange; }
</style>
</head>
<body>
<h1>Voice & Servo Control Monitor</h1>

<!-- Servo æ§åˆ¶å€ -->
<h2>ğŸ¤– Servo Control</h2>
<button onclick="sendMove('up')">â¯… Up</button>
<button onclick="sendMove('down')">â¯† Down</button>
<button onclick="sendMove('left')">â¯‡ Left</button>
<button onclick="sendMove('right')">â¯ˆ Right</button>

<!-- æ‹ç…§è¨­å®šå€ -->
<h2>ğŸ“¸ æ‹ç…§è¨­å®š</h2>
Width: <input type="number" id="width" value="1280" style="width:80px;">
Height: <input type="number" id="height" value="720" style="width:80px;">
<br><br>
<button onclick="capture()">ğŸ“¸ Capture</button>

<!-- é¡¯ç¤ºæœ€æ–°ç…§ç‰‡ -->
<h2>ğŸ“¸ æœ€æ–°ç…§ç‰‡</h2>
<img id="photo" src="">

<!-- èªéŸ³ç›£è½ç‹€æ…‹ -->
<h2>ğŸ¤ èªéŸ³è¾¨è­˜ç‹€æ…‹</h2>
<p id="status">ğŸŸ¢ èƒŒæ™¯ç›£è½ä¸­...</p>
<p id="alert"></p>
<p id="text"></p>

<script>
const serverIP = location.hostname;
const ws = new WebSocket(`ws://${serverIP}:8081`);
const photo = document.getElementById('photo');
const textElement = document.getElementById('text');
const alertElement = document.getElementById('alert');

ws.onopen = () => console.log('âœ… WebSocket connected');

ws.onmessage = (event) => {
  const text = event.data.trim().toLowerCase();
  console.log("æ”¶åˆ°èªéŸ³æ–‡å­—:", text);

  alertElement.style.display = 'none';
  textElement.style.display = 'block';
  textElement.textContent = `ğŸ¤ è¾¨è­˜åˆ°: ${text}`;
  textElement.style.color = "black";

  if (text.includes("help")) {
    showAlert("ğŸš¨ EMERGENCY! ç·Šæ€¥ç‹€æ³ ğŸš¨", 'emergency');
    sendCommand("emergency");
  } else if (text.includes("hello")) {
    showAlert("ğŸ’¡ é–‹ç‡ˆæŒ‡ä»¤å·²é€å‡ºï¼", 'light-on');
    sendCommand("light on");
  } else if (text.includes("bye bye")) {
    showAlert("ğŸ’¤ é—œç‡ˆæŒ‡ä»¤å·²é€å‡ºï¼", 'light-off');
    sendCommand("light off");
  }
};

function sendMove(dir) {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(`move ${dir}`);
  }
}

function capture() {
  const width  = document.getElementById('width').value;
  const height = document.getElementById('height').value;
  photo.style.display = 'none';

  fetch(`http://${serverIP}:8080/capture?width=${width}&height=${height}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        photo.src = `/uploads/${data.filename}?t=${Date.now()}`;
        photo.onload = () => photo.style.display = 'block';
      }
    })
    .catch(() => photo.style.display = 'none');
}

function sendCommand(cmd) {
  fetch(`http://${serverIP}:8080/send?cmd=${encodeURIComponent(cmd)}`)
    .then(res => {
      if (res.ok) console.log(`âœ… æŒ‡ä»¤ ${cmd} å·²é€å‡º`);
      else console.error(`âŒ æŒ‡ä»¤ ${cmd} ç™¼é€å¤±æ•—`);
    })
    .catch(err => console.error(`âŒ æŒ‡ä»¤ç™¼é€éŒ¯èª¤:`, err));
}

function showAlert(message, cssClass) {
  alertElement.style.display = 'block';
  alertElement.textContent = message;
  alertElement.className = cssClass;
}

// æ”¯æ´éµç›¤ç®­é ­æŒ‰éµç§»å‹•
document.addEventListener('keydown', e => {
  switch (e.key) {
    case 'ArrowUp':    sendMove('up');    break;
    case 'ArrowDown':  sendMove('down');  break;
    case 'ArrowLeft':  sendMove('left');  break;
    case 'ArrowRight': sendMove('right'); break;
  }
});
</script>
</body>
</html>
